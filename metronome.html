<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Metronome (URL-sync)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e0f1a;
      --text: #e8e9f0;
      --muted: #a9acc4;
      --hi: #ff6b6b;   /* high beat color */
      --lo: #f5a524;   /* low beat color */
      --mu: #9aa0a6;   /* mute color */
      --active: #5b8cff;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .wrap { width: 100%; max-width: 720px; }
    h1 { margin: 0 0 14px; font-size: 22px; font-weight: 650; }
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
      margin-bottom: 16px;
    }
    @media (max-width: 640px) {
      .controls { grid-template-columns: 1fr 1fr; }
      .controls button { grid-column: 1 / -1; }
    }
    .field { display: grid; gap: 6px; }
    .label { font-size: 12px; color: var(--muted); }
    input[type="number"], input[type="text"] {
      background: #141726;
      color: var(--text);
      border: 1px solid #2a2f45;
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
    }
    input[type="number"]:focus, input[type="text"]:focus {
      border-color: #3856ff88;
      box-shadow: 0 0 0 6px rgba(91,140,255,0.18);
    }
    input[readonly] {
      background: #0f1118;
      color: var(--muted);
      cursor: default;
    }
    input[readonly]:focus {
      border-color: #2a2f45;
      box-shadow: none;
    }
    button {
      appearance: none;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #2a3055;
      background: linear-gradient(180deg, #2b3567, #23305d);
      color: #eef1ff;
      font-weight: 600;
      letter-spacing: 0.2px;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.05); }
    .beatbar {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(0, 48px);
      gap: 12px;
      justify-content: start;
      margin-top: 12px;
      user-select: none;
    }
    .beat {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: #2a2d3f;
      border: 2px solid #3a3f5c;
      display: grid; place-items: center;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .1s ease, border-color .1s ease;
      position: relative;
    }
    .beat:active { transform: translateY(1px) scale(0.98); }
    .beat.high { background: #2a2d3f; border-color: #5a2e2e; }
    .beat.low  { background: #2a2d3f; border-color: #6e5227; }
    .beat.mute { background: #2a2d3f; border-color: #4b5166; opacity: 0.8; }
    .dot {
      width: 14px; height: 14px; border-radius: 50%;
      background: var(--mu);
      box-shadow: 0 0 0 6px rgba(255,255,255,0.02);
      transition: background .1s ease, box-shadow .1s ease;
    }
    .high .dot { background: var(--hi); box-shadow: 0 0 0 6px rgba(255,107,107,0.15); }
    .low  .dot { background: var(--lo); box-shadow: 0 0 0 6px rgba(245,165,36,0.15); }
    .mute .dot { background: var(--mu); box-shadow: 0 0 0 6px rgba(154,160,166,0.12); }
    .beat.active .dot {
      box-shadow: 0 0 0 8px rgba(91,140,255,0.20), 0 0 24px rgba(91,140,255,0.45);
    }
    .legend {
      margin-top: 10px;
      font-size: 12px; color: var(--muted);
    }
    .legend span { display: inline-flex; align-items: center; gap: 6px; margin-right: 12px; }
    .swatch { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .swatch.hi { background: var(--hi); }
    .swatch.lo { background: var(--lo); }
    .swatch.mu { background: var(--mu); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Metronome</h1>

    <div class="controls">
      <div class="field">
        <div class="label">Tempo (BPM)</div>
        <input id="bpm" type="number" min="1" max="900" value="110" />
      </div>
      <div class="field">
        <div class="label">Beats per bar</div>
        <input id="beats" type="number" min="1" max="64" value="4" />
      </div>
      <div class="field">
        <div class="label">High frequency (Hz)</div>
        <input id="highFreq" type="number" min="1" max="4000" value="880" />
      </div>
      <div class="field">
        <div class="label">Low frequency (Hz)</div>
        <input id="lowFreq" type="number" min="1" max="4000" value="220" />
      </div>
      <button id="toggleBtn">Start</button>
      <div class="field" style="grid-column: 1 / -1;">
        <div class="label">Pattern (high,low,mute)</div>
        <input id="pattern" type="text" value="low,high,high,high" readonly />
      </div>
    </div>

    <div id="beatBar" class="beatbar" aria-label="Beat pattern"></div>
    <div class="legend">
      <span><i class="swatch hi"></i> high</span>
      <span><i class="swatch lo"></i> low</span>
      <span><i class="swatch mu"></i> mute</span>
      <span>Click a beat to cycle: high â†’ low â†’ mute</span>
    </div>
  </div>

  <script>
    // ---------- State ----------
    const $ = (id) => document.getElementById(id);

    // ðŸŒŸ COLLECTED CONSTANTS ðŸŒŸ
    const CONSTANTS = {
      // Input Constraints
      BPM_MIN: 1,
      BPM_MAX: 900,
      BEATS_MIN: 1,
      BEATS_MAX: 64,
      FREQ_MIN: 1,
      FREQ_MAX: 4000,
      // Default/Initial Values 
      BPM_DEFAULT: 110, 
      BEATS_DEFAULT: 4,
      HIGH_FREQ_DEFAULT: 880,
      LOW_FREQ_DEFAULT: 220,
      // Metronome Engine
      MIN_INTERVAL_MS: 10,
      CLICK_DURATION_S: 0.1,
      CLICK_GAIN_ATTACK: 0.8,
      CLICK_GAIN_DECAY: 0.001,
    };

    const SOUND_CYCLE = ["high", "low", "mute"];
    const ALIASES = { h: "high", hi: "high", l: "low", lo: "low", m: "mute", mu: "mute", 1: "high", 2: "low", 0: "mute" };

    const state = {
      bpm: CONSTANTS.BPM_DEFAULT,
      beats: CONSTANTS.BEATS_DEFAULT,
      highFreq: CONSTANTS.HIGH_FREQ_DEFAULT,
      lowFreq: CONSTANTS.LOW_FREQ_DEFAULT,
      sounds: ["low", "high", "high", "high"], // Initial pattern example
      playing: false,
      currentBeat: 0,
      timer: null,
      audio: null
    };

    // ---------- Audio (crisp "black-screen" click) ----------
    function ensureAudio() {
      if (!state.audio) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        state.audio = { ctx };
      }
      if (state.audio.ctx.state === "suspended") state.audio.ctx.resume();
    }

    function playClick(type) {
      if (type === "mute") return;
      const ctx = state.audio.ctx;
      const t = ctx.currentTime;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();

      // Crisp, percussive ticks
      osc.type = "square";
      const freq = (type === "high") ? state.highFreq : state.lowFreq;
      osc.frequency.setValueAtTime(freq, t);

      g.gain.setValueAtTime(CONSTANTS.CLICK_GAIN_ATTACK, t);
      //g.gain.exponentialRampToValueAtTime(1.0, t + 0.002);   // sharp attack (commented out in original)
      g.gain.exponentialRampToValueAtTime(CONSTANTS.CLICK_GAIN_DECAY, t + 0.05);  // short decay (0.05s)

      osc.connect(g).connect(ctx.destination);
      osc.start(t);
      osc.stop(t + CONSTANTS.CLICK_DURATION_S);
    }

    // ---------- URL sync ----------
    function readFromURL() {
      const p = new URLSearchParams(location.search);
      const bpm = parseInt(p.get("bpm"));
      const beats = parseInt(p.get("beats"));
      const highFreq = parseInt(p.get("highFreq"));
      const lowFreq = parseInt(p.get("lowFreq"));
      const pattern = p.get("pattern");

      if (!isNaN(bpm)) state.bpm = clamp(bpm, CONSTANTS.BPM_MIN, CONSTANTS.BPM_MAX);
      if (!isNaN(beats)) state.beats = clamp(beats, CONSTANTS.BEATS_MIN, CONSTANTS.BEATS_MAX);
      if (!isNaN(highFreq)) state.highFreq = clamp(highFreq, CONSTANTS.FREQ_MIN, CONSTANTS.FREQ_MAX);
      if (!isNaN(lowFreq)) state.lowFreq = clamp(lowFreq, CONSTANTS.FREQ_MIN, CONSTANTS.FREQ_MAX);
      if (pattern) state.sounds = normalizePattern(pattern, state.beats);

      // Reflect into inputs - using state values now, not hardcoded defaults
      $("bpm").value = state.bpm;
      $("beats").value = state.beats;
      $("highFreq").value = state.highFreq;
      $("lowFreq").value = state.lowFreq;
      $("pattern").value = state.sounds.join(",");
    }

    function writeToURL() {
      const url = new URL(location.href);
      url.searchParams.set("bpm", String(state.bpm));
      url.searchParams.set("beats", String(state.beats));
      url.searchParams.set("highFreq", String(state.highFreq));
      url.searchParams.set("lowFreq", String(state.lowFreq));
      url.searchParams.set("pattern", state.sounds.join(","));
      history.replaceState(null, "", url);
    }

    // ---------- Helpers ----------
    function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

    function normalizeToken(tok) {
      if (!tok) return "high";
      const t = String(tok).toLowerCase().trim();
      if (t === "high" || t === "low" || t === "mute") return t;
      if (t in ALIASES) return ALIASES[t];
      return "high";
    }

    function normalizePattern(str, beats) {
      const parts = String(str).split(",").map(s => normalizeToken(s));
      const arr = parts.slice(0, beats);
      while (arr.length < beats) arr.push("high");
      return arr;
    }

    function cycleSound(s) {
      const i = SOUND_CYCLE.indexOf(s);
      return SOUND_CYCLE[(i + 1) % SOUND_CYCLE.length];
    }

    // ---------- UI render ----------
    function renderBeatBar() {
      const bar = $("beatBar");
      bar.innerHTML = "";
      for (let i = 0; i < state.beats; i++) {
        const s = state.sounds[i] || "high";
        const el = document.createElement("div");
        el.className = `beat ${s}`;
        el.title = `Beat ${i + 1}: ${s}`;
        const dot = document.createElement("div");
        dot.className = "dot";
        el.appendChild(dot);

        el.addEventListener("click", () => {
          state.sounds[i] = cycleSound(state.sounds[i]);
          // Update UI immediately without full re-render
          el.className = `beat ${state.sounds[i]}`;
          el.title = `Beat ${i + 1}: ${state.sounds[i]}`;
          // Reflect in pattern field + URL
          $("pattern").value = state.sounds.join(",");
          writeToURL();
        });

        bar.appendChild(el);
      }
    }

    function setActiveBeat(idx) {
      const beats = document.querySelectorAll(".beat");
      beats.forEach((b, i) => b.classList.toggle("active", i === idx));
    }

    // ---------- Metronome engine ----------
    function start() {
      ensureAudio();
      state.playing = true;
      state.currentBeat = 0;
      setActiveBeat(-1);
      if (state.timer) clearInterval(state.timer);
      state.timer = setInterval(tick, Math.max(CONSTANTS.MIN_INTERVAL_MS, 60000 / state.bpm));
      $("toggleBtn").textContent = "Stop";
    }

    function stop() {
      state.playing = false;
      if (state.timer) clearInterval(state.timer);
      state.timer = null;
      setActiveBeat(-1);
      $("toggleBtn").textContent = "Start";
    }

    function tick() {
      const idx = state.currentBeat % state.beats;
      setActiveBeat(idx);
      playClick(state.sounds[idx]);
      state.currentBeat++;
    }

    function rebuildIfPlaying() {
      if (state.playing) {
        clearInterval(state.timer);
        state.timer = setInterval(tick, Math.max(CONSTANTS.MIN_INTERVAL_MS, 60000 / state.bpm));
        state.currentBeat = 0;
      }
    }

    // ---------- Input bindings ----------
    $("toggleBtn").addEventListener("click", () => {
      state.playing ? stop() : start();
    });

    $("bpm").addEventListener("input", () => {
      state.bpm = clamp(parseInt($("bpm").value || String(CONSTANTS.BPM_DEFAULT)), CONSTANTS.BPM_MIN, CONSTANTS.BPM_MAX);
      $("bpm").value = state.bpm;
      writeToURL();
      rebuildIfPlaying();
    });

    $("bpm").addEventListener("focus", () => {
      $("bpm").select();
    });

    $("beats").addEventListener("input", () => {
      state.beats = clamp(parseInt($("beats").value || String(CONSTANTS.BEATS_DEFAULT)), CONSTANTS.BEATS_MIN, CONSTANTS.BEATS_MAX);
      $("beats").value = state.beats;
      // Adjust pattern to match new beats count
      state.sounds = (state.sounds || []).slice(0, state.beats);
      while (state.sounds.length < state.beats) state.sounds.push("high");
      $("pattern").value = state.sounds.join(",");
      writeToURL();
      renderBeatBar();
      state.currentBeat = 0;
      rebuildIfPlaying();
    });

    $("beats").addEventListener("focus", () => {
      $("beats").select();
    });

    $("highFreq").addEventListener("input", () => {
      state.highFreq = clamp(parseInt($("highFreq").value || String(CONSTANTS.HIGH_FREQ_DEFAULT)), CONSTANTS.FREQ_MIN, CONSTANTS.FREQ_MAX);
      $("highFreq").value = state.highFreq;
      writeToURL();
    });

    $("highFreq").addEventListener("focus", () => {
      $("highFreq").select();
    });

    $("lowFreq").addEventListener("input", () => {
      state.lowFreq = clamp(parseInt($("lowFreq").value || String(CONSTANTS.LOW_FREQ_DEFAULT)), CONSTANTS.FREQ_MIN, CONSTANTS.FREQ_MAX);
      $("lowFreq").value = state.lowFreq;
      writeToURL();
    });

    $("lowFreq").addEventListener("focus", () => {
      $("lowFreq").select();
    });

    // ---------- Init ----------
    readFromURL();
    renderBeatBar();
    writeToURL();
  </script>
</body>
</html>